{
  "content": "# User Authentication\n\nHandles user login, session management, and access control for the platform.\n\n## Core Responsibilities\n\n- Validate user credentials against database\n- Generate and manage JWT tokens\n- Enforce role-based access control (RBAC)\n- Handle password reset workflows\n- Manage user sessions and timeouts\n\n## Authentication Flow\n\n```mermaid\nsequenceDiagram\n    participant User\n    participant API\n    participant AuthService\n    participant Database\n    participant TokenManager\n    participant SessionStore\n\n    User->>API: POST /api/auth/login\n    API->>AuthService: validateCredentials(email, password)\n    AuthService->>Database: findUser(email)\n    Database-->>AuthService: user record\n    AuthService->>AuthService: bcrypt.compare(password, hash)\n    alt Invalid credentials\n        AuthService-->>API: Error: Invalid credentials\n        API-->>User: 401 Unauthorized\n    else Valid credentials\n        AuthService->>TokenManager: generateToken(userId, roles)\n        TokenManager-->>AuthService: JWT token\n        AuthService->>SessionStore: storeSession(token, userId)\n        SessionStore-->>AuthService: Success\n        AuthService-->>API: { token, user }\n        API-->>User: 200 OK { token, user }\n    end\n```\n\n## System Architecture\n\n```mermaid\ngraph TB\n    subgraph Client Layer\n        UI[Web UI]\n        Mobile[Mobile App]\n    end\n\n    subgraph API Layer\n        AuthAPI[Auth API Endpoints]\n        AuthMiddleware[Auth Middleware]\n    end\n\n    subgraph Service Layer\n        PasswordService[Password Service]\n        TokenManager[Token Manager]\n        SessionManager[Session Manager]\n    end\n\n    subgraph Data Layer\n        DB[(User Database)]\n        Redis[(Redis Session Store)]\n    end\n\n    UI --> AuthAPI\n    Mobile --> AuthAPI\n    AuthAPI --> PasswordService\n    AuthAPI --> TokenManager\n    PasswordService --> DB\n    TokenManager --> Redis\n    SessionManager --> Redis\n    AuthMiddleware --> TokenManager\n    AuthMiddleware --> SessionManager\n\n    style AuthAPI fill:#4299e1,color:#fff\n    style AuthMiddleware fill:#4299e1,color:#fff\n    style PasswordService fill:#48bb78,color:#fff\n    style TokenManager fill:#48bb78,color:#fff\n    style DB fill:#ed8936,color:#fff\n    style Redis fill:#ed8936,color:#fff\n```\n\n## Key Components\n\n### Password Service\n\n**File**: `auth/password-service.js`\n\nHandles password hashing, validation, and reset workflows. Uses bcrypt with 10 rounds for hashing.\n\n```javascript\n// Example usage\nconst hashedPassword = await PasswordService.hash('userPassword');\nconst isValid = await PasswordService.verify('userPassword', hashedPassword);\n```\n\n### Token Manager\n\n**File**: `auth/token-manager.js`\n\nGenerates and validates JWT tokens. Manages token refresh and expiration logic.\n\n**Token Structure:**\n- Payload: `{ userId, email, roles, exp }`\n- Expiration: 24 hours\n- Refresh: Sliding window of 7 days\n\n### Auth Middleware\n\n**File**: `auth/middleware.js`\n\nExpress middleware that protects routes by verifying JWT tokens and checking user permissions.\n\n### Session Store\n\n**File**: `auth/session-store.js`\n\nRedis-based session storage for quick token validation and user state management.\n\n## Data Flow Diagram\n\n```mermaid\nflowchart LR\n    A[User Login Request] --> B{Credentials Valid?}\n    B -->|No| C[Return 401 Error]\n    B -->|Yes| D[Hash Password Check]\n    D --> E[Generate JWT Token]\n    E --> F[Store Session in Redis]\n    F --> G[Return Token to Client]\n    G --> H[Client Stores Token]\n    H --> I[Subsequent Requests]\n    I --> J[Middleware Validates Token]\n    J -->|Invalid| K[Return 401]\n    J -->|Valid| L[Proceed to Route Handler]\n```\n\n## State Machine: Session Lifecycle\n\n```mermaid\nstateDiagram-v2\n    [*] --> LoggedOut\n    LoggedOut --> Authenticating: Login Request\n    Authenticating --> LoggedIn: Valid Credentials\n    Authenticating --> LoggedOut: Invalid Credentials\n    LoggedIn --> Active: User Activity\n    Active --> LoggedIn: Token Valid\n    Active --> RefreshingToken: Token Expiring\n    RefreshingToken --> Active: Token Refreshed\n    RefreshingToken --> LoggedOut: Refresh Failed\n    Active --> LoggedOut: Manual Logout\n    Active --> LoggedOut: Session Timeout\n    LoggedOut --> [*]\n```\n\n## Permission Hierarchy\n\n```mermaid\ngraph TD\n    Admin[Admin Role] --> Manager[Manager Role]\n    Manager --> User[User Role]\n    User --> Guest[Guest Role]\n    \n    Admin -.\"Can perform all actions\".-> Action1[Create Users]\n    Admin -.-> Action2[Delete Users]\n    Admin -.-> Action3[Modify Permissions]\n    \n    Manager -.\"Can manage content\".-> Action4[Create Content]\n    Manager -.-> Action5[Edit Content]\n    \n    User -.\"Can view and edit own data\".-> Action6[View Profile]\n    User -.-> Action7[Update Profile]\n    \n    Guest -.\"Read-only access\".-> Action8[Browse Public Content]\n\n    style Admin fill:#e53e3e,color:#fff\n    style Manager fill:#dd6b20,color:#fff\n    style User fill:#38a169,color:#fff\n    style Guest fill:#718096,color:#fff\n```\n\n## Why it matters\n\nAuthentication is the foundation of platform security. Any vulnerability here could compromise the entire system. This domain ensures that only authorized users can access protected resources and that user identities are verified correctly.\n\n**Business Impact:**\n- Protects user data and privacy\n- Prevents unauthorized access to sensitive features\n- Maintains compliance with security standards (GDPR, SOC2)\n- Builds user trust through secure account management\n\n## Risk Areas\n\n### Critical Security Concerns\n\n1. **Password Security**\n   - All passwords must be hashed with bcrypt before storage\n   - Never log or expose passwords in plain text\n   - Enforce minimum password complexity\n\n2. **Token Expiration**\n   - Expired tokens must be rejected to prevent unauthorized access\n   - Implement proper token rotation\n   - Clear sessions on logout\n\n3. **Session Hijacking**\n   - Tokens should be transmitted only over HTTPS\n   - Implement CSRF protection\n   - Rotate session IDs after privilege escalation\n\n4. **Brute Force Protection**\n   - Login attempts should be rate-limited\n   - Implement account lockout after failed attempts\n   - Log suspicious activity\n\n5. **Token Storage**\n   - Store tokens securely (httpOnly cookies preferred)\n   - Never expose tokens in URLs or localStorage unnecessarily\n   - Implement proper CORS policies\n\n## Performance Considerations\n\n```mermaid\ngraph LR\n    A[Request] --> B{Token in Redis?}\n    B -->|Cache Hit| C[Fast Path: 2-5ms]\n    B -->|Cache Miss| D[Database Lookup: 50-100ms]\n    D --> E[Update Redis Cache]\n    E --> C\n    C --> F[Proceed with Request]\n```\n\n- **Redis caching** reduces database load by 95%\n- Token validation averages **2-5ms** with cache hit\n- Session cleanup runs every hour to remove expired entries\n- Database connection pooling prevents bottlenecks during peak auth requests\n",
  "metadata": {
    "lastUpdated": "2026-02-22T10:30:00.000Z",
    "wordCount": 450,
    "diagramCount": 6,
    "componentCount": 4
  }
}
